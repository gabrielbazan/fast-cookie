FROM python:3.10


ENV SERVICE_NAME=api

ENV ENV=dev

ENV WORK_DIR=/code
ENV REQUIREMENTS_FILENAME=requirements.frozen

ENV WAIT_FOR_SERVICE_SCRIPT_PATH=./wait-service.sh

ENV DATABASE_SERVICE_NAME=database
ARG DATABASE_PORT=5432
ENV WAIT_FOR_DATABASE="${WAIT_FOR_SERVICE_SCRIPT_PATH} ${DATABASE_SERVICE_NAME} ${DATABASE_PORT}"
ENV ALEMBIC_INIT="alembic upgrade head"

ENV API_HOST=0.0.0.0
ENV API_PORT=5000
ENV API_START="uvicorn main:app --host ${API_HOST} --port ${API_PORT} --reload"


EXPOSE ${API_PORT}


WORKDIR ${WORK_DIR}


COPY ${SERVICE_NAME} .

RUN pip install -r ${REQUIREMENTS_FILENAME}


CMD ${WAIT_FOR_DATABASE} && ${ALEMBIC_INIT} && ${API_START}
